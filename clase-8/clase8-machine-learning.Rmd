---
title: "clase3-tidyverse"
author: "Martín Alalu & Ramiro Fernández"
date: "26/7/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


reproducir

regression random forest sobre jugadores metricas del match
https://uc-r.github.io/random_forests
```{r}
#install.packages("rsample")
#install.packages("randomForest")
#install.packages("ranger")
#install.packages("caret")
#install.packages("h2o")

library(tidyverse)
library(rsample)      # data splitting 
library(randomForest) # basic implementation
library(ranger)       # a faster implementation of randomForest
library(caret)        # an aggregator package for performing many machine learning models
library(h2o)          # an extremely fast java-based platform
jugadores_superliga_arg <- read_csv('jugadores_superliga_argentina.csv')
```

Hago un breve vistazo de las variables
```{r}
glimpse(jugadores_superliga_arg)
```

```{r}
set.seed(123)
jugadores_superliga_arg <- jugadores_superliga_arg[, colSums(is.na(jugadores_superliga_arg)) == 0]
jugadores_split <- initial_split(jugadores_superliga_arg, prop = .7)
jugadores_train <- training(jugadores_split)
jugadores_test  <- testing(jugadores_split)

m1 <- randomForest(
  formula = xg ~ .,
  data    = jugadores_train
)
m1
plot(m1)
```

```{r}
which.min(m1$mse)
sqrt(m1$mse[which.min(m1$mse)])
valid_split <- initial_split(jugadores_train, .8)
# training data
jugadores_train_v2 <- analysis(valid_split)
# validation data
jugadores_valid <- assessment(valid_split)
x_test <- jugadores_valid[setdiff(names(jugadores_valid), "xg")]
y_test <- jugadores_valid$xg

rf_oob_comp <- randomForest(
  formula = xg ~ .,
  data    = jugadores_train_v2,
  xtest   = x_test,
  ytest   = y_test
)

# extract OOB & validation errors
oob <- sqrt(rf_oob_comp$mse)
validation <- sqrt(rf_oob_comp$test$mse)

# compare error rates
tibble::tibble(
  `Out of Bag Error` = oob,
  `Test error` = validation,
  ntrees = 1:rf_oob_comp$ntree
) %>%
  gather(Metric, RMSE, -ntrees) %>%
  ggplot(aes(ntrees, RMSE, color = Metric)) +
  geom_line() +
  scale_y_continuous(labels = scales::dollar) +
  xlab("Number of trees")


# names of features
features <- setdiff(names(jugadores_train), "xg")

set.seed(123)

m2 <- tuneRF(
  x          = jugadores_train[features],
  y          = jugadores_train$xg,
  ntreeTry   = 500,
  mtryStart  = 5,
  stepFactor = 1.5,
  improve    = 0.01,
  trace      = FALSE      # to not show real-time progress 
)


```

```{r}
sparse_matrix <- sparse.model.matrix(response ~ .-1, data = campaign)

```

CODIGO: https://github.com/Dato-Futbol/xg-model

DATA: https://figshare.com/collections/Soccer_match_event_dataset/4415000/2

PAPER: https://www.nature.com/articles/s41597-019-0247-7

```{r}

## Loading R packages and source the "getshots" customized own function
source("getshots.R")
#install.packages("jsonlite")
#install.packages("ggsoccer")
library(jsonlite)
library(ggsoccer)
```

## Getting processed shots data from JSON files of 5 leagues and join them (previous downloading datasets is required)
shotsEN <- get_shots("events/events_England.json", "EN")
shotsFR <- get_shots("events/events_France.json", "FR")
shotsGE <- get_shots("events/events_Germany.json", "GE")
shotsIT <- get_shots("events/events_Italy.json", "IT")
shotsSP <- get_shots("events/events_Spain.json", "SP")

shots <- shotsEN %>%
  bind_rows(shotsFR, shotsGE, shotsIT, shotsSP) %>%
  mutate(is_goal2 = ifelse(is_goal == 1, T, F))

write_rds(shots, "all_unblocked_shots.rds")


# Viz 1: all unblocked shots
ggplot(data = shots, aes(y = y_1, x = x_1)) +
        annotate_pitch(colour = "white",
                       fill   = "black",
                       limits = FALSE) +
        theme_pitch() +
        theme(plot.background = element_rect(fill = "black"),
              title = element_text(colour = "white")) +
        coord_flip(xlim = c(51, 101),
                   ylim = c(-1, 101)) +
        geom_jitter(aes(fill = factor(is_goal2, levels = c("TRUE", "FALSE"))),
                    alpha = 0.3, shape = 21, size = 0.8) +
        facet_wrap(~is_goal2, nrow = 1) +
        scale_fill_manual(values = c("red", "#00BFFF")) +
        scale_colour_manual(values = c("red", "#00BFFF")) +
        theme(legend.position = c(0.75, 1.12), legend.direction = "horizontal",
              legend.text = element_text(color = "white", size = 8, face = "plain"),
              legend.background = element_rect(fill = "black"),
              legend.key = element_rect(fill = "black"),
              strip.background=element_rect(fill = "black"),
              strip.text = element_text(colour = "black"),
              plot.title = element_text(hjust = 0.07, face = "plain"),
              plot.subtitle = element_text(hjust = 0.07, size = 10, face = "italic"),
              plot.caption = element_text(hjust = 0.95),
              plot.margin = margin(1, 0.2, 0.5, 0.2, "cm")) +
        labs(fill = "Goal?", caption = "@DatoFutbol_cl") +
        guides(fill = guide_legend(override.aes = list(alpha = 0.8, size = 2), reverse=T)) +
        ggtitle("Unblocked open play shots", "Top 5 European Leagues 2017-2018")

ggsave("shots_plot.png", width = 10, height = 5)









